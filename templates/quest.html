<script>
  const output = document.getElementById("output");
  const input = document.getElementById("userInput");
  const form = document.getElementById("answerForm");
  const btn = document.getElementById("submitBtn");

  let gameStarted = false;   // becomes true when server confirms a runner
  let runnerAlive = false;   // becomes true while the runner is alive

  function append(text) {
    if (!text) return;
    output.value += text + "\n";
    output.scrollTop = output.scrollHeight;
  }

  async function startGame() {
    append("--- Starting game ---");
    try {
      const res = await fetch("/play", {
        method: "POST",
        credentials: "same-origin",       // <--- ensure session cookie is sent
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "start" })
      });
      const data = await res.json();
      append(data.output);
      // If server returned that a runner exists, mark started
      runnerAlive = !data.finished;
      gameStarted = true;
      if (data.finished) {
        append("--- Game already finished on server ---");
      }
    } catch (e) {
      append("Error starting game: " + e);
      gameStarted = false;
      runnerAlive = false;
    }
    input.focus();
  }

  async function sendAnswer(answer) {
    if (!answer) return;
    if (!gameStarted) {
      append("Game not started yet. Wait a moment and try again.");
      return;
    }
    if (!runnerAlive) {
      append("No active runner on the server. Click Start again.");
      return;
    }

    btn.disabled = true;
    append("> " + answer);

    try {
      const res = await fetch("/play", {
        method: "POST",
        credentials: "same-origin",       // <--- ensure session cookie is sent
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "answer", answer })
      });
      const data = await res.json();
      append(data.output);
      // Update runnerAlive based on server's finished flag
      runnerAlive = !data.finished;
      if (data.finished) append("--- Game finished ---");
    } catch (e) {
      append("Network error: " + e);
    } finally {
      btn.disabled = false;
      input.focus();
    }
  }

  form.addEventListener("submit", (ev) => {
    ev.preventDefault();
    const val = input.value.trim();
    if (!val) return;
    sendAnswer(val);
    input.value = "";
  });

  btn.addEventListener("click", (ev) => {
    ev.preventDefault();
    const val = input.value.trim();
    if (!val) return;
    sendAnswer(val);
    input.value = "";
  });

  // Start the game on load, but allow some time for session cookies to settle
  // (if user just got redirected here)
  window.addEventListener("load", () => {
    // small delay helps ensure the session cookie from the form POST is in place
    setTimeout(startGame, 150); 
  });
</script>
