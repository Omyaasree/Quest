<script>
  const output = document.getElementById("output");
  const input = document.getElementById("userInput");
  const form = document.getElementById("answerForm");
  const btn = document.getElementById("submitBtn");

  let gameStarted = false;
  let runnerAlive = false;

  function append(text) {
    if (!text) return;
    output.value += text + "\n";
    output.scrollTop = output.scrollHeight;
  }

  async function startGame() {
    append("--- Starting game ---");
    try {
      console.log("Sending start request...");
      const res = await fetch("/play", {
        method: "POST",
        credentials: "same-origin",            // <--- send cookies
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "start" })
      });
      const data = await res.json();
      console.log("Start response:", data);
      append(data.output);
      gameStarted = true;
      runnerAlive = !data.finished;
      if (data.finished) append("--- Game already finished on server ---");
    } catch (e) {
      console.error("Error starting game:", e);
      append("Error starting game: " + e);
      gameStarted = false;
      runnerAlive = false;
    }
    input.focus();
  }

  async function sendAnswer(answer) {
    if (!answer) return;
    if (!gameStarted) {
      append("Game not started yet. Wait a moment and try again.");
      return;
    }
    if (!runnerAlive) {
      append("No active runner on the server. Click Start again.");
      return;
    }

    btn.disabled = true;
    append("> " + answer);

    try {
      const res = await fetch("/play", {
        method: "POST",
        credentials: "same-origin",            // <--- send cookies
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "answer", answer })
      });
      const data = await res.json();
      console.log("Answer response:", data);
      append(data.output);
      runnerAlive = !data.finished;
      if (data.finished) append("--- Game finished ---");
    } catch (e) {
      console.error("Network error:", e);
      append("Network error: " + e);
    } finally {
      btn.disabled = false;
      input.focus();
    }
  }

  form.addEventListener("submit", (ev) => {
    ev.preventDefault();
    const val = input.value.trim();
    if (!val) return;
    sendAnswer(val);
    input.value = "";
  });

  btn.addEventListener("click", (ev) => {
    ev.preventDefault();
    const val = input.value.trim();
    if (!val) return;
    sendAnswer(val);
    input.value = "";
  });

  // Slight delay to ensure session cookie from POST-redirect has settled
  window.addEventListener("load", () => setTimeout(startGame, 150));
</script>
